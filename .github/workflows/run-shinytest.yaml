# from: https://github.com/rstudio/shiny-testing-gha-example/blob/single_platform_snapshot/.github/workflows/run-tests.yaml
on:
  push:
  pull_request:

name: Run shinytest

jobs:
  run-tests:
    runs-on: ${{ matrix.config.os }}

    name: ${{ matrix.config.os }} (${{ matrix.config.r }})

    strategy:
      fail-fast: false
      matrix:
        config:
          # disabled b/c shinytest on windows has an error
          #- {os: windows-latest, r: 'release'}
          # disabled due to race conditions / parallelism
          #- {os: macOS-latest, r: 'release'}
          - {os: ubuntu-20.04, r: 'release', rspm: "https://packagemanager.rstudio.com/cran/__linux__/focal/latest"}

    env:
      R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
      RSPM: ${{ matrix.config.rspm }}

    steps:
      # do not convert line feeds in windows
      - name: Windows git setup
        if: runner.os == 'Windows'
        run:
          git config --global core.autocrlf false

      - uses: actions/checkout@v2

      - uses: r-lib/actions/setup-r@master
        with:
          r-version: ${{ matrix.config.r }}

      - uses: r-lib/actions/setup-pandoc@master

      - name: Query dependencies
        run: |
          install.packages('remotes')
          writeLines(sprintf("R-%i.%i", getRversion()$major, getRversion()$minor), ".github/R-version")
        shell: Rscript {0}

      - name: Cache R packages
        if: runner.os != 'Windows'
        uses: actions/cache@v1
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1
          restore-keys: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1-

      # TODO: Better sysreqs handling
      - name: Install system dependencies
        if: runner.os == 'Linux'
        env:
          RHUB_PLATFORM: linux-x86_64-ubuntu-gcc
        run: |
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            phantomjs
      - name: Install dependencies
        run: |
          install.packages("renv")
          renv::restore()
        shell: Rscript {0}

      - name: Find PhantomJS path
        id: phantomjs
        run: |
          echo "::set-output name=path::$(Rscript -e 'cat(shinytest:::phantom_paths()[[1]])')"
      - name: Cache PhantomJS
        uses: actions/cache@v1
        with:
          path: ${{ steps.phantomjs.outputs.path }}
          key: ${{ runner.os }}-phantomjs
          restore-keys: ${{ runner.os }}-phantomjs
      - name: Install PhantomJS
        shell: Rscript {0}
        run: |
          options(install.packages.check.source = "no")
          if (!shinytest::dependenciesInstalled()) shinytest::installDependencies()
      - name: Run tests
        shell: Rscript {0}
        run: |
          shiny::runTests(".", assert = TRUE)
      - name: Check test results
        shell: Rscript {0}
        run: |
          results <- shinytest::textTestDiff()
          clean_results <- attr(results, "status")
          if (any(clean_results == "reject")) {
            cat(results)
            stop("Failing tests on differences")
          }
      - name: Produce test output widgets
        if: failure()
        shell: Rscript {0}
        run: |
          shinytest_files <- dir("tests/shinytest")
          tests <- sub("\\.R$", "", shinytest_files[grepl(".*\\.R$", shinytest_files)])
          output_dir <- "tests/shinytest/diff-viewer"
          dir.create(output_dir, showWarnings = FALSE)
          # save html widget diff results
          invisible(lapply(tests, function(test) {
            test_widget <- shinytest::viewTestDiffWidget(
                testname = test
            )
            current_wd <- getwd()
            setwd(output_dir)
            output_file <- paste0(test, ".html")
            htmlwidgets::saveWidget(
              test_widget,
              output_file
            )
            setwd(current_wd)
          }))
      - name: Produce test output display
        if: failure()
        run: |
          cat << EOF > tests/shinytest/diff-viewer/index.html
          <html>
            <head>
              <script>
                function setSrc(param) {
                  iframe = document.getElementById("iframe")
                  iframe.src = param + ".html"
                }
              </script>
            </head>
            <input id="mytest-button" type="button" value="mytest Results" onclick="setSrc('mytest');" />
            <input id="philtest-button" type="button" value="philtest Results" onclick="setSrc('philtest');" />
          <iframe id="iframe" src="mytest.html" style="width:100%; height:100%">
          </iframe>
          </html>
          EOF
          cat << EOF > tests/shinytest/diff-viewer/manifest.json
          {
            "version": 1,
            "locale": "en_US",
            "platform": "3.6.3",
            "metadata": {
              "appmode": "static",
              "primary_rmd": null,
              "primary_html": "index.html",
              "content_category": null,
              "has_parameters": false
            },
            "packages": null,
            "files": {
              "index.html": {
                "checksum": "682a7334024b7ecd44ae699ff5bf55e6"
              },
              "mytest.html": {
                "checksum": "70d2ad9f7e33b602d40529ea2f80ae31"
              },
              "philtest.html": {
                "checksum": "c9aa348bea0b0b1e993de4f2e062bd79"
              }
            },
            "users": null
          }
          EOF
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@master
        with:
          name: ${{ runner.os }}-r${{ matrix.config.r }}-tests
          path: tests
      - name: Deploy test output widget to RStudio Connect
        if: failure()
        uses: rstudio/actions/connect-publish@main
        with:
          url: https://colorado.rstudio.com/rsc/
          api-key: ${{ secrets.CONNECT_API_KEY }}
          access-type: all
          show-logs: true
          dir: |
            ./tests/shinytest/diff-viewer:/pr/shinytest-example-app/${{ runner.os.GITHUB_HEAD_REF }}-diff/
